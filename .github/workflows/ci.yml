name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  BUILD_TYPE: Release

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install CMake
      run: |
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'

    - name: Create Build Directory
      run: mkdir build
      shell: cmd

    - name: Configure CMake
      working-directory: build
      run: cmake .. -DCMAKE_BUILD_TYPE=Release

    - name: Build
      working-directory: build
      run: cmake --build . --config Release

    - name: List Build Artifacts
      working-directory: build
      run: dir Raveland_artefacts\Release /s /b

    - name: Upload Windows Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Raveland-Windows
        path: |
          build/Raveland_artefacts/Release/Standalone/RaveLand.exe
          build/Raveland_artefacts/Release/VST3/RaveLand.vst3/

  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Initialize Submodules
      run: git submodule update --init --recursive

    - name: Install CMake
      run: brew install cmake

    - name: Create Build Directory
      run: mkdir build

    - name: Configure CMake
      working-directory: build
      run: cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64"

    - name: Build
      working-directory: build
      run: cmake --build . --config Release

    - name: List Build Artifacts
      working-directory: build
      run: find Raveland_artefacts -type f -name "*" | head -20

    - name: Upload macOS Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Raveland-macOS
        path: |
          build/Raveland_artefacts/Release/Standalone/RaveLand.app/
          build/Raveland_artefacts/Release/VST3/RaveLand.vst3/
          build/Raveland_artefacts/Release/AU/RaveLand.component/

  build-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Initialize Submodules
      run: git submodule update --init --recursive

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libasound2-dev libjack-jackd2-dev libgtk-3-dev libwebkit2gtk-4.0-dev libfreetype6-dev libx11-dev libxext-dev libxinerama-dev libxcursor-dev libxrandr-dev

    - name: Create Build Directory
      run: mkdir build

    - name: Configure CMake
      working-directory: build
      run: cmake .. -DCMAKE_BUILD_TYPE=Release

    - name: Build
      working-directory: build
      run: cmake --build . --config Release

    - name: List Build Artifacts
      working-directory: build
      run: find Raveland_artefacts -type f -name "*" | head -20

    - name: Upload Linux Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Raveland-Linux
        path: |
          build/Raveland_artefacts/Release/Standalone/RaveLand
          build/Raveland_artefacts/Release/VST3/RaveLand.vst3/
          build/Raveland_artefacts/Release/LV2/RaveLand.lv2/