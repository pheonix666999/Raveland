name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  BUILD_TYPE: Release

jobs:
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Verify Submodules
      run: |
        git submodule status --recursive
        Get-ChildItem -Force extern
        Get-ChildItem -Force extern/JUCE

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install CMake
      run: |
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y

    - name: Configure CMake
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DJUCE_BUILD_EXAMPLES=OFF -DJUCE_BUILD_EXTRAS=OFF -DCMAKE_CXX_FLAGS="/MP /EHsc"

    - name: Build
      run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel 2

    - name: List Build Artifacts
      shell: cmd
      run: dir build\\Raveland_artefacts\\%BUILD_TYPE% /s /b

    - name: Upload Windows Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Raveland-Windows
        path: |
          build/Raveland_artefacts/${{ env.BUILD_TYPE }}/Standalone/RaveLand.exe
          build/Raveland_artefacts/${{ env.BUILD_TYPE }}/VST3/RaveLand.vst3/

  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Verify Submodules
      run: |
        ls -la extern
        ls -la extern/JUCE

    - name: Install CMake
      run: brew install cmake

    - name: Create Build Directory
      run: mkdir build

    - name: Configure CMake
      working-directory: build
      run: |
        ls -la ../extern/JUCE/
        cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" -DJUCE_BUILD_EXAMPLES=OFF -DJUCE_BUILD_EXTRAS=OFF -DCMAKE_CXX_FLAGS="-Wno-deprecated-declarations"

    - name: Build
      working-directory: build
      run: cmake --build . --config Release --parallel 2

    - name: List Build Artifacts
      working-directory: build
      run: find Raveland_artefacts -type f -name "*" | head -20

    - name: Prepare code signing (optional)
      if: ${{ secrets.MACOS_CERT_P12_BASE64 != '' && secrets.MACOS_CERT_PASSWORD != '' && secrets.MACOS_SIGNING_IDENTITY != '' }}
      run: |
        set -euo pipefail
        CERT_P12="$RUNNER_TEMP/cert.p12"
        echo "${{ secrets.MACOS_CERT_P12_BASE64 }}" | base64 --decode > "$CERT_P12"

        KEYCHAIN_PASSWORD="$(uuidgen)"
        echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> "$GITHUB_ENV"

        security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
        security set-keychain-settings -lut 21600 build.keychain

        security import "$CERT_P12" -k build.keychain -P "${{ secrets.MACOS_CERT_PASSWORD }}" -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" build.keychain

    - name: Write notarization key (optional)
      if: ${{ secrets.APPLE_NOTARY_KEY_BASE64 != '' }}
      run: |
        set -euo pipefail
        NOTARY_KEY="$RUNNER_TEMP/notary_api_key.p8"
        echo "${{ secrets.APPLE_NOTARY_KEY_BASE64 }}" | base64 --decode > "$NOTARY_KEY"
        echo "APPLE_NOTARY_KEY_PATH=$NOTARY_KEY" >> "$GITHUB_ENV"

    - name: Sign + notarize artefacts (optional, recommended for distribution)
      if: ${{ secrets.MACOS_CERT_P12_BASE64 != '' && secrets.MACOS_CERT_PASSWORD != '' && secrets.MACOS_SIGNING_IDENTITY != '' }}
      env:
        APPLE_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        APPLE_NOTARY_KEY_ID: ${{ secrets.APPLE_NOTARY_KEY_ID }}
        APPLE_NOTARY_ISSUER_ID: ${{ secrets.APPLE_NOTARY_ISSUER_ID }}
        APPLE_NOTARY_KEY_PATH: ${{ env.APPLE_NOTARY_KEY_PATH }}
      run: |
        set -euo pipefail
        bash scripts/macos_sign_and_notarize.sh build/Raveland_artefacts/Release dist

    - name: Build macOS installer package (.pkg) (optional)
      if: ${{ secrets.MACOS_CERT_P12_BASE64 != '' && secrets.MACOS_CERT_PASSWORD != '' && secrets.MACOS_SIGNING_IDENTITY != '' }}
      env:
        APPLE_INSTALLER_IDENTITY: ${{ secrets.MACOS_INSTALLER_IDENTITY }}
      run: |
        set -euo pipefail
        bash scripts/macos_make_installer_pkg.sh build/Raveland_artefacts/Release dist

    - name: Upload macOS Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Raveland-macOS
        path: |
          build/Raveland_artefacts/${{ env.BUILD_TYPE }}/Standalone/RaveLand.app/
          build/Raveland_artefacts/${{ env.BUILD_TYPE }}/VST3/RaveLand.vst3/
          build/Raveland_artefacts/${{ env.BUILD_TYPE }}/AU/RaveLand.component/
          dist/RaveLand-macOS.zip
          dist/RaveLand-Installer.pkg
