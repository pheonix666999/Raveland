name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  BUILD_TYPE: Release

jobs:
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Verify Submodules
      run: |
        git submodule status --recursive
        Get-ChildItem -Force extern
        Get-ChildItem -Force extern/JUCE

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install CMake
      run: |
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y

    - name: Configure CMake
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DJUCE_BUILD_EXAMPLES=OFF -DJUCE_BUILD_EXTRAS=OFF -DCMAKE_CXX_FLAGS="/MP /EHsc"

    - name: Build
      run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel 2

    - name: List Build Artifacts
      shell: cmd
      run: dir build\\Raveland_artefacts\\%BUILD_TYPE% /s /b

    - name: Upload Windows Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Raveland-Windows
        path: |
          build/Raveland_artefacts/${{ env.BUILD_TYPE }}/Standalone/RaveLand.exe
          build/Raveland_artefacts/${{ env.BUILD_TYPE }}/VST3/RaveLand.vst3/

  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Verify Submodules
      run: |
        ls -la extern
        ls -la extern/JUCE

    - name: Install CMake
      run: brew install cmake

    - name: Create Build Directory
      run: mkdir build

    - name: Configure CMake
      working-directory: build
      run: |
        ls -la ../extern/JUCE/
        cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" -DJUCE_BUILD_EXAMPLES=OFF -DJUCE_BUILD_EXTRAS=OFF -DCMAKE_CXX_FLAGS="-Wno-deprecated-declarations"

    - name: Build
      working-directory: build
      run: cmake --build . --config Release --parallel 2

    - name: List Build Artifacts
      working-directory: build
      run: find Raveland_artefacts -type f -name "*" | head -20

    - name: Upload macOS Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Raveland-macOS
        path: |
          build/Raveland_artefacts/${{ env.BUILD_TYPE }}/Standalone/RaveLand.app/
          build/Raveland_artefacts/${{ env.BUILD_TYPE }}/VST3/RaveLand.vst3/
